---
title: "POMA: Statistical analysis tool for targeted metabolomic data"
subtitle: "Intelligent Statistical Analysis: Metabolomic analysis for more than 2 groups using selected 'Pre-processing' by user"
date: '`r format(Sys.Date(), "%B, %Y")`'
output: 
  html_document:
    toc: yes
    toc_depth: 4
    theme: united
    number_sections: true
params:
  n: NA
---

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
options(knitr.table.format = "html") 

data <- params$n
#data <- readr::read_csv("/Users/pol/Dropbox/Shiny_apps/POMA/ST000284/MET_CRC_ST000284.csv")
#data <- cbind(ID = seq(1:150), iris[,c(5,1:4)])
colnames(data)[1:2] <- c("ID", "Group")
```

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
samples_group <- data[,1:2]
data_norm <- data[,c(-1,-2)]
```

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
#normality
normality <- data.frame(pval=apply(data_norm[,3:ncol(data_norm)],2,function(x) {shapiro.test(x)$p.value}))
normality$pval <- p.adjust(normality$pval, method = "fdr")
normality$names <- rownames(normality)
names.normality <- normality[normality$pval >= 0.05,2]
names.non.normality <- normality[normality$pval < 0.05,2]
```

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}
## NORMAL
data_no <- data_norm[,colnames(data_norm) %in% names.normality]
data_no <-cbind(samples_group,data_no)

if(ncol(data_no) == 3){
  colnames(data_no)[3]<-colnames(data_norm)[colnames(data_norm) %in% names.normality]
}

## NON NORMAL
data_non_no <- data_norm[,colnames(data_norm) %in% names.non.normality]
data_non_no <-cbind(samples_group,data_non_no)

if(ncol(data_non_no) == 3){
  colnames(data_non_no)[3]<-colnames(data_norm)[colnames(data_norm) %in% names.non.normality]
}

```

# Parametric tests

## ANOVA

### Metabolites with NORMAL distribution

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}

Group <- as.factor(data_no$Group)

if(ncol(data_no)>3){
  
stat2 <- function(x){anova(aov(x ~ Group, data=data_no))$"Pr(>F)"[1]}
p2 <- as.data.frame(apply(FUN=stat2, MARGIN = 2, X = data_no[,c(3:ncol(data_no))]))
colnames(p2) <- c("P.Value")
p2$adj.P.Val <- p.adjust(p2$P.Value, method = "fdr")

p2 <- round(p2,5)
p2 <- p2[order(p2$adj.P.Val, decreasing = FALSE),]

p2 %>%
  mutate(Metabolite = row.names(.),
       adj.P.Val = cell_spec(adj.P.Val, "html", 
                             color = ifelse(adj.P.Val <= 0.05, "red", "black"))) %>%
  dplyr::select(Metabolite, P.Value, adj.P.Val) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)
}

if(ncol(data_no) == 3){
  
p2 <- data.frame(anova(aov(data_no[,3] ~ Group, data=data_no))$"Pr(>F)"[1])
colnames(p2) <- c("P.Value")

p2 <- round(p2,5)

p2 %>%
  mutate(Metabolite = row.names(.),
       P.Value = cell_spec(P.Value, "html", 
                             color = ifelse(P.Value <= 0.05, "red", "black"))) %>%
  dplyr::select(Metabolite, P.Value) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)
}

```

# Non Parametric tests 

## Kruskal Wallis Test

### Metabolites with NON NORMAL distribution

```{r, echo = FALSE, warning = FALSE, comment = NA, message=FALSE}

Group <- as.factor(data_non_no$Group)

if(ncol(data_non_no)>3){

p2 <- as.data.frame(apply(data_non_no[,3:ncol(data_non_no)],2,function(x){kruskal.test(x ~ as.factor(Group))$p.value}))
colnames(p2) <- c("P.Value")
p2$adj.P.Val <- p.adjust(p2$P.Value, method = "fdr")

p2 <- round(p2,5)
p2 <- p2[order(p2$adj.P.Val, decreasing = FALSE),]

p2 %>%
  mutate(Metabolite = row.names(.),
       adj.P.Val = cell_spec(adj.P.Val, "html", 
                             color = ifelse(adj.P.Val <= 0.05, "red", "black"))) %>%
  dplyr::select(Metabolite, P.Value, adj.P.Val) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)
}

if(ncol(data_no) == 3){
  
p2 <- data.frame(kruskal.test(data_non_no[,3] ~ as.factor(data_non_no$Group))$p.value)
colnames(p2) <- c("P.Value")

p2 <- round(p2,5)

p2 %>%
  mutate(Metabolite = row.names(.),
       P.Value = cell_spec(P.Value, "html", 
                             color = ifelse(P.Value <= 0.05, "red", "black"))) %>%
  dplyr::select(Metabolite, P.Value) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)
}


```

